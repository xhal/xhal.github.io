{
    "version": "https://jsonfeed.org/version/1",
    "title": "星辰大海 • All posts by \"redis\" tag",
    "description": "学习、编程、生活",
    "home_page_url": "http://liuh.cc",
    "items": [
        {
            "id": "http://liuh.cc/2023/01/dacefe23.html",
            "url": "http://liuh.cc/2023/01/dacefe23.html",
            "title": "Redis7 源码安装",
            "date_published": "2023-01-02T13:03:52.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><blockquote>\n<p>源码安装 Redis7, 下载源码、解压、执行安装命令</p>\n</blockquote>\n<span id=\"more\"></span>\n<h3 id=\"1-下载-redis-7-源码\"><a class=\"markdownIt-Anchor\" href=\"#1-下载-redis-7-源码\">#</a> 1、下载 Redis 7 源码</h3>\n<p>可以从 Redis 官网（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZWRpcy5pby9kb3dubG9hZCVFRiVCQyU4OSVFNiU4OCU5NiVFOCU4MCU4NQ==\">https://redis.io/download）或者</span> GitHub 上（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3JlZGlzL3JlZGlzL3JlbGVhc2VzJUVGJUJDJTg5JUU0JUI4JThCJUU4JUJEJUJEJUU2JTlDJTgwJUU2JTk2JUIwJUU3JTg5JTg4JUU2JTlDJUFDJUU3JTlBJTg0\">https://github.com/redis/redis/releases）下载最新版本的</span> Redis 源码包，也可以使用以下命令下载最新的稳定版：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://download.redis.io/releases/redis-7.0.0.tar.gz</pre></td></tr></table></figure><h3 id=\"2-解压源码包\"><a class=\"markdownIt-Anchor\" href=\"#2-解压源码包\">#</a> 2、解压源码包</h3>\n<p>使用以下命令解压下载的源码包：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tar</span> xzf redis-7.0.0.tar.gz</pre></td></tr></table></figure><h3 id=\"3-编译安装\"><a class=\"markdownIt-Anchor\" href=\"#3-编译安装\">#</a> 3、编译安装</h3>\n<p>进入解压后的 Redis 目录，执行以下命令编译 Redis：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> redis-7.0.0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr></table></figure><p>这一步会生成 Redis 的可执行文件，包括 redis-server、redis-cli 等。</p>\n<h3 id=\"4-安装-redis\"><a class=\"markdownIt-Anchor\" href=\"#4-安装-redis\">#</a> 4、安装 Redis</h3>\n<p>执行以下命令安装 Redis：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><p>这一步会将 Redis 可执行文件复制到 /usr/local/bin 目录下，并将 Redis 配置文件复制到 /etc/redis 目录下。</p>\n<p>若需要指定安装目录，则添加 <code>PREFIX</code>  配置</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 指定 安装目录 PREFIX</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span>/usr/local/redis <span class=\"token function\">install</span></pre></td></tr></table></figure><h3 id=\"5-配置-redis\"><a class=\"markdownIt-Anchor\" href=\"#5-配置-redis\">#</a> 5、配置 Redis</h3>\n<p>编辑 /etc/redis/redis.conf 配置文件，修改 Redis 的配置，例如修改监听的端口、设置密码、配置持久化等。</p>\n<h3 id=\"6-启动-redis\"><a class=\"markdownIt-Anchor\" href=\"#6-启动-redis\">#</a> 6、启动 Redis</h3>\n<p>执行以下命令启动 Redis：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>redis-server /etc/redis/redis.conf</pre></td></tr></table></figure><p>如果 Redis 需要认证，还需要在启动 Redis 时指定密码：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>redis-server /etc/redis/redis.conf <span class=\"token parameter variable\">--requirepass</span> your_password</pre></td></tr></table></figure><h3 id=\"7-测试-redis\"><a class=\"markdownIt-Anchor\" href=\"#7-测试-redis\">#</a> 7、测试 Redis</h3>\n<p>执行以下命令连接 Redis 并测试：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>redis-cli</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> <span class=\"token function\">ping</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PONG</pre></td></tr></table></figure><p>如果 Redis 返回 PONG，则说明 Redis 已经正常运行。</p>\n<p>以上是 Redis 7 源码安装的步骤，需要注意的是，在安装 Redis 时需要根据实际情况修改配置，例如修改监听的端口、设置密码、配置持久化等。同时，在部署 Redis 时，还需要注意安全性和性能等问题，例如限制 Redis 的网络访问权限、优化 Redis 的性能等。</p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "http://liuh.cc/2022/10/8b778184.html",
            "url": "http://liuh.cc/2022/10/8b778184.html",
            "title": "Redis+Keepalived_实现双机主从互备【互为主从、主从自动切换】",
            "date_published": "2022-10-06T02:30:03.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><blockquote>\n<p>实际生产中，系统压力不大且仅两台物理服务器；实际一个 Redis 服务完全够用，但为了高可用及容灾备份，又不够哨兵模式的三台，所以做此实现方案。</p>\n</blockquote>\n<h2 id=\"1-资源配置\"><a class=\"markdownIt-Anchor\" href=\"#1-资源配置\">#</a> 1、资源配置：</h2>\n<blockquote>\n<p>实际服务器：<br>\n192.168.30.7【从】 、 192.168.30.8【主】</p>\n<p>(Redis) 虚拟 IP: 192.168.30.6<br>\n 系统服务，配置连接此虚拟 IP 即可</p>\n</blockquote>\n<h2 id=\"2-在两台服务器上安装-redis-安装目录-usrlocalredis\"><a class=\"markdownIt-Anchor\" href=\"#2-在两台服务器上安装-redis-安装目录-usrlocalredis\">#</a> 2、在两台服务器上安装 Redis 安装目录  <code>/usr/local/redis</code></h2>\n<p>安装步骤，可参考上篇教程：  <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpdXF3MjMxL2FydGljbGUvZGV0YWlscy8xMjkwNTIyNjA=\">Centos7.9 源码安装 Redis 5.x</span></p>\n<p>**【必须用到】** 里面的启动脚本文件  <code>redis.sh</code></p>\n<h2 id=\"3-增加redis配置文件-masterconf-slaveconf\"><a class=\"markdownIt-Anchor\" href=\"#3-增加redis配置文件-masterconf-slaveconf\">#</a> 3、增加 redis 配置文件  <code>master.conf</code>  /  <code>slave.conf</code></h2>\n<p>在目录  <code>/usr/local/redis/conf </code>  下新增<br>\n <code>master.conf</code>  从原  <code>redis.conf</code>  复制，配置文件两台服务器一样就行，如果有配置访问密码一定要一致</p>\n<p><code>slave.conf</code>  配置文件，主要区别如下：<br>\n192.168.30.8【主】配置：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># replicaof 配置对方 IP 端口</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>replicaof <span class=\"token number\">192.168</span>.30.7  <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 访问密码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>masterauth <span class=\"token string\">\"xxx123\"</span></pre></td></tr></table></figure><p>192.168.30.7【从】配置：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># replicaof 配置对方 IP 端口</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>replicaof <span class=\"token number\">192.168</span>.30.8  <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 访问密码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>masterauth <span class=\"token string\">\"xxx123\"</span></pre></td></tr></table></figure><p>配置文件修改完成后，启动服务：<br>\n启动 Redis 192.168.30.8【主】 以 【master】 方式启动</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># /usr/local/redis/redis.sh startmaster</span></pre></td></tr></table></figure><p>启动 Redis 192.168.30.7【从】 以 【slave】 方式启动</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># /usr/local/redis/redis.sh startslave</span></pre></td></tr></table></figure><h2 id=\"4-支持-keepalived-配置脚本文件\"><a class=\"markdownIt-Anchor\" href=\"#4-支持-keepalived-配置脚本文件\">#</a> 4、支持 Keepalived 配置脚本文件</h2>\n<p>于目录  <code>/usr/local/redis/</code>  创建脚本  <code>vip_keepalived.sh</code>  （主从一样）：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 虚拟 IP (Virtual IP) 检测实现 - keepalived 调用实现</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Keepalived vrrp_script 原理:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#     根据调用的 script 脚本结果进行分析：</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#     -  如果执行结果【为 0】， 且 weight 配置的值【大于 0】，则优先级相应的【增加】</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#     -  如果执行结果【非 0】， 且 weight 配置的值【小于 0】，则优先级相应的【减少】</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 实现原理：   本方案 weight 配置的值 建议【大于 0】, priority 相等、preempt 模式</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#   1、检测当前节点服务是否正常、若正常且为 master 主节点，则使 vip 为指向本机</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#   2、若本机节点服务进程不存在（则由从节点判定），以下为从节点判断逻辑</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#      - 当前节点服务进程是否正常，若正常则判断下 redis 中的 role 是否为 slave</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#      - 如果是 slave ，判断 master_link_status 是否为 up</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#      - 如果不为 up, 则代表主节点连接不上，则修改本节点为 master, 则使 vip 为指向本节点</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#   PS: 本脚本需要配合 redis.sh 使用</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># @author hal@xhal.net 2022-09-08</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">BASE_PATH</span><span class=\"token operator\">=</span>/usr/local/redis</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 备份方案，仅检测服务状态 （此方案不能切换为 master）</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 0 表示检查进程是否运行</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># /usr/bin/killall -0 redis-server </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 本方案 weight 配置的值 建议【大于 0】, priority 相等、preempt 模式</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 1、检测当前节点服务是否正常、若正常且为 master 主节点，返回 0 </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token function-name function\">check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\"># 判断运行的角色 [master, slave] master 返回 0， slave 返回 1, 其它 返回 2， redis 未运行 返回 9</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token variable\">$BASE_PATH</span>/redis.sh role</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token assign-left variable\">redisRole</span><span class=\"token operator\">=</span><span class=\"token variable\">$?</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"当前 redis role值： [<span class=\"token variable\">$redisRole</span>]\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$redisRole</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\"># redis 有运行，且为 master 主节点，返回 0</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$redisRole</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"1\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">#echo \"redis 有运行，且为 slave 状态\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\"># 判断 master_link_status 是否为 up</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token variable\">$BASE_PATH</span>/redis.sh slaveup</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token comment\">#echo \"slave 连接 master 正常\" </span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token comment\"># slave 连接 master 已断开，修改本节点为 master</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token variable\">$BASE_PATH</span>/redis.sh tomaster</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token comment\">#echo \"其它状态，直接返回对应结果 [$redisRole]\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token variable\">$redisRole</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">#echo \"redis 未运行，直接返回 1\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>check</pre></td></tr></table></figure><p>于目录  <code>/usr/local/redis/</code>  创建脚本  <code>vip_log.sh</code>  （主从一样）：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 记录 Keepalived 切换事件日志</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># @author hal@xhal.net 2022-09-08</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">now</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> <span class=\"token string\">\"+%Y-%m-%d %H:%M:%S\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">LOG_FILE_PATH</span><span class=\"token operator\">=</span>/usr/local/redis/logs/keepalived.log</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$now</span> -- <span class=\"token variable\">$1</span>\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$LOG_FILE_PATH</span></pre></td></tr></table></figure><h2 id=\"5-修改-keepalived-配置\"><a class=\"markdownIt-Anchor\" href=\"#5-修改-keepalived-配置\">#</a> 5、修改 Keepalived 配置</h2>\n<p>修改 192.168.30.8【主】 Keepalived 配置  <code>/etc/keepalived/keepalived.conf</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Redis 相关配置，开始 =======================</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>vrrp_script chk_redis <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    script <span class=\"token string\">\"/usr/local/redis/vip_keepalived.sh \"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    interval <span class=\"token number\">5</span> <span class=\"token comment\"># 检测时间间隔</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    weight <span class=\"token number\">88</span>  <span class=\"token comment\"># 如果条件成立的话【script 执行结果为 0】，则权重值按此增加</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    fall <span class=\"token number\">2</span>     <span class=\"token comment\"># 定义检测失败的最大次数，如果设置为 3 表示请求失败 2 次时，就认为节点故障</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    rise <span class=\"token number\">1</span>     <span class=\"token comment\"># 定义请求成功的次数，如果设置为 1 表示一次请求成功后，就认为节点恢复正常</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 定义虚拟路由，VI_Redis 为虚拟路由的标示符，自己定义名称</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>vrrp_instance VI_Redis <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    state BACKUP               <span class=\"token comment\"># 来决定主从 MASTER BACKUP</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    interface ens192           <span class=\"token comment\"># 绑定虚拟 IP 的网络接口，根据自己的机器填写</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    virtual_router_id <span class=\"token number\">8</span>        <span class=\"token comment\"># 虚拟路由的 ID 号， 两个节点设置必须一样</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.30.8  <span class=\"token comment\"># 填写本机 ip</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    priority <span class=\"token number\">100</span>               <span class=\"token comment\"># 节点优先级，主要比从节点优先级高</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    preempt                    <span class=\"token comment\"># 优先级高的设置 nopreempt 解决异常恢复后再次抢占的问题</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">1</span>               <span class=\"token comment\"># 组播信息发送间隔，两个节点设置必须一样，默认 1s</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\"># 将 track_script 块加入 instance 配置块</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        chk_redis <span class=\"token comment\">#执行 Redis 监控的服务</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\"># 变为 MASTER 后执行脚本</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    notify_master <span class=\"token string\">\"/usr/local/redis/vip_log.sh to_be_【master】\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># 变为 BACKUP 后执行脚本</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    notify_backup <span class=\"token string\">\"/usr/local/redis/vip_log.sh to_be_【slave】\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\"># 状态变为 FAULT 后执行脚本</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    notify_fault  <span class=\"token string\">\"/usr/local/redis/vip_log.sh keepalived_is_Fault\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\"># VRRP 停止 后执行脚本</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    notify_stop  <span class=\"token string\">\"/usr/local/redis/vip_log.sh keepalived_is_stop...!\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token number\">192.168</span>.30.6 <span class=\"token comment\">#虚拟 ip</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>修改完成后， 重启 keepalived</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart keepalived.service</span></pre></td></tr></table></figure><p>修改 192.168.30.7【从】 Keepalived 配置  <code>/etc/keepalived/keepalived.conf</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Redis 相关配置，开始 =======================</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>vrrp_script chk_redis <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    script <span class=\"token string\">\"/usr/local/redis/vip_keepalived.sh \"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    interval <span class=\"token number\">5</span> <span class=\"token comment\"># 检测时间间隔</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    weight <span class=\"token number\">88</span>  <span class=\"token comment\"># 如果条件成立的话【script 执行结果为 0】，则权重值按此增加</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    fall <span class=\"token number\">2</span>     <span class=\"token comment\"># 定义检测失败的最大次数，如果设置为 3 表示请求失败 2 次时，就认为节点故障</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    rise <span class=\"token number\">1</span>     <span class=\"token comment\"># 定义请求成功的次数，如果设置为 1 表示一次请求成功后，就认为节点恢复正常</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 定义虚拟路由，VI_Redis 为虚拟路由的标示符，自己定义名称</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>vrrp_instance VI_Redis <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    state BACKUP               <span class=\"token comment\"># 来决定主从 MASTER BACKUP</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    interface ens192           <span class=\"token comment\"># 绑定虚拟 IP 的网络接口，根据自己的机器填写</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    virtual_router_id <span class=\"token number\">8</span>        <span class=\"token comment\"># 虚拟路由的 ID 号， 两个节点设置必须一样</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.30.7  <span class=\"token comment\"># 填写本机 ip</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    priority <span class=\"token number\">100</span>               <span class=\"token comment\"># 节点优先级，主要比从节点优先级高</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    preempt                    <span class=\"token comment\"># 优先级高的设置 nopreempt 解决异常恢复后再次抢占的问题</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    advert_int <span class=\"token number\">1</span>               <span class=\"token comment\"># 组播信息发送间隔，两个节点设置必须一样，默认 1s</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\"># 将 track_script 块加入 instance 配置块</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        chk_redis <span class=\"token comment\">#执行 Redis 监控的服务</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\"># 变为 MASTER 后执行脚本</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    notify_master <span class=\"token string\">\"/usr/local/redis/vip_log.sh to_be_【master】\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\"># 变为 BACKUP 后执行脚本</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    notify_backup <span class=\"token string\">\"/usr/local/redis/vip_log.sh to_be_【slave】\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># 状态变为 FAULT 后执行脚本</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    notify_fault  <span class=\"token string\">\"/usr/local/redis/vip_log.sh keepalived_is_Fault\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\"># VRRP 停止 后执行脚本</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    notify_stop  <span class=\"token string\">\"/usr/local/redis/vip_log.sh keepalived_is_stop...!\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token number\">192.168</span>.30.6 <span class=\"token comment\">#虚拟 ip</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token comment\"># 当存在 IP 冲突时，可指定单播 ip 为对方 IP</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\"># unicast_peer &#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\"># 192.168.30.8  # 另一台 IP</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">#&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>修改完成后， 重启 keepalived</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart keepalived.service</span></pre></td></tr></table></figure><h2 id=\"6-修改开机启动-redisservice-配置命令\"><a class=\"markdownIt-Anchor\" href=\"#6-修改开机启动-redisservice-配置命令\">#</a> 6、修改开机启动  <code>redis.service</code>  配置命令</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 服务描述</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Redis-Server</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 在 XX 服务后启动</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 服务运行参数； 注意本节点内命令要用绝对路径</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 后台运行方式</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>forking</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 启动命令 (主要修改此部分由 start 修改为 startauto)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/redis/redis.sh startauto</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 是否给服务分配独立的临时空间</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">PrivateTmp</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 运行级别下服务安装的相关设置， 可设置为多用户，即系统运行级别为 3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure>",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "http://liuh.cc/2022/08/4b3066d5.html",
            "url": "http://liuh.cc/2022/08/4b3066d5.html",
            "title": "Centos7.9_源码安装Redis_5.x",
            "date_published": "2022-08-08T00:18:08.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h2 id=\"1-环境及版本\"><a class=\"markdownIt-Anchor\" href=\"#1-环境及版本\">#</a> 1、环境及版本</h2>\n<p>系统版本： Centos 7.9.2009</p>\n<p>Redis:  5.0.14</p>\n<h2 id=\"2-源码安装cd-redis-5014\"><a class=\"markdownIt-Anchor\" href=\"#2-源码安装cd-redis-5014\">#</a> 2、源码安装 cd redis-5.0.14</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-zxvf</span> redis-5.0.14.tar.gz</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">cd</span> redis-5.0.14</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">make</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 指定 安装目录 PREFIX</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span>/usr/local/redis <span class=\"token function\">install</span></pre></td></tr></table></figure><h1 id=\"指定-安装目录-prefix\"><a class=\"markdownIt-Anchor\" href=\"#指定-安装目录-prefix\">#</a> 指定 安装目录 PREFIX</h1>\n<p>make PREFIX=/usr/local/redis install</p>\n<h2 id=\"3-复制-修改-redisconf-配置\"><a class=\"markdownIt-Anchor\" href=\"#3-复制-修改-redisconf-配置\">#</a> 3、复制、修改 [redis.conf] 配置</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 redis 下的配置目录</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /usr/local/redis/conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /usr/local/redis/data</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /usr/local/redis/logs</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 创建完成后，目录结构</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># tree /usr/local/redis/</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/usr/local/redis/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>├── bin</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>│     ├── redis-benchmark</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>│     ├── redis-check-aof</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>│     ├── redis-check-rdb</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>│     ├── redis-cli</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>│     ├── redis-sentinel -<span class=\"token operator\">></span> redis-server</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>│     └── redis-server</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>├── conf   <span class=\"token comment\"># 配置文件存放目录</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">|</span>     └── redis.conf   <span class=\"token comment\"># 从 源码包 复制过来的默认配置文件</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>├── data   <span class=\"token comment\"># rdb 数据文件存放目录</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>├── logs   <span class=\"token comment\"># 日志文件存放目录</span></pre></td></tr></table></figure><p>修改 [redis.conf] 配置</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim conf/redis.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># bind IP 配置</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 守护进程方式运行</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>daemonize <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 日志文件路径（配置到上方创建的日志目录）</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>logfile <span class=\"token string\">\"/usr/local/redis/log/redis_6379.log\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 数据文件存放目录</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">dir</span> <span class=\"token string\">\"/usr/local/redis/data\"</span></pre></td></tr></table></figure><h2 id=\"4-创建启动脚本方便操作\"><a class=\"markdownIt-Anchor\" href=\"#4-创建启动脚本方便操作\">#</a> 4、创建启动脚本方便操作</h2>\n<p>脚本支持效果如下：</p>\n<p><img data-src=\"http://img.xhal.cc/picgo/redis_command.png\" alt=\"redis命令\"></p>\n<p>在目录 [/usr/local/redis/] 下创建脚本文件 [ <span class=\"exturl\" data-url=\"aHR0cDovL3JlZGlzLnNo\">redis.sh</span> ] 内容：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Redis 启动脚本</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># @author: hal@xhal.net 2022-08-06</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 脚本当前目录</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">SH_DIR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">cd</span> <span class=\"token punctuation\">$(</span> <span class=\"token function\">dirname</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token environment constant\">BASH_SOURCE</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">APP_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"redis-server\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 根路径</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#APP_PATH=/usr/local/redis</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">APP_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$SH_DIR</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">BIN_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$APP_PATH</span>/bin</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 配置文件路径</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">CONF_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$APP_PATH</span>/conf</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">CONF_FILE_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$CONF_PATH</span>/redis.conf</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">MASTER_CONF_FILE_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$CONF_PATH</span>/master.conf</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">SLAVE_CONF_FILE_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$CONF_PATH</span>/slave.conf</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 运行端口 - 默认 6379</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">APP_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># Redis 密码 - 默认为空</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token assign-left variable\">APP_PASS</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">## 从配置文件，读取端口、密码</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_STR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> $CONF_FILE_PATH <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-E</span> <span class=\"token string\">'^port|^requirepass'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#echo \"CONFIG_STR: $CONFIG_STR\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token assign-left variable\">PORT_STR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> $CONFIG_STR <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/port \\([0-9]*\\).*/\\1/g'</span> <span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">PASS_STR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> $CONFIG_STR <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/.*requirepass \\(.*\\)/\\1/g'</span> <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/\"//g'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#echo \"PORT_STR: $PORT_STR</span><span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>#echo \"</span>PASS_STR: <span class=\"token variable\">$PASS_STR</span><span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>if [ -n \"</span><span class=\"token variable\">$PORT_STR</span><span class=\"token string\">\" ]; then</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  APP_PORT=<span class=\"token variable\">$PORT_STR</span>;</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>fi</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>if [ -n \"</span><span class=\"token variable\">$PASS_STR</span><span class=\"token string\">\" ]; then</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  APP_PASS=<span class=\"token variable\">$PASS_STR</span>;</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>fi</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre># 处理密码连接字符串</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>PASS_KEY=\"</span>\"</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_PASS</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token assign-left variable\">PASS_KEY</span><span class=\"token operator\">=</span><span class=\"token string\">\"-a <span class=\"token variable\">$APP_PASS</span>\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[35m======================================================================<span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">#使用说明 用来提示参数</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token function-name function\">usage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[33mAPP_PATH:<span class=\"token entity\" title=\"\\e\">\\e</span>[0m <span class=\"token entity\" title=\"\\e\">\\e</span>[36m <span class=\"token variable\">$APP_PATH</span> <span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[33mUsage:<span class=\"token entity\" title=\"\\e\">\\e</span>[0m    <span class=\"token entity\" title=\"\\e\">\\e</span>[36m <span class=\"token variable\">$0</span> [start|stop|restart] <span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[33mUsage:<span class=\"token entity\" title=\"\\e\">\\e</span>[0m    <span class=\"token entity\" title=\"\\e\">\\e</span>[36m <span class=\"token variable\">$0</span> [status|running|role|slaveup] <span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[33mUsage:<span class=\"token entity\" title=\"\\e\">\\e</span>[0m    <span class=\"token entity\" title=\"\\e\">\\e</span>[36m <span class=\"token variable\">$0</span> [tomaster|toslave|startmaster|startslave|startauto] <span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[35m----------------------------------------------------------------------<span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m start   <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 正常启动 Redis，<span class=\"token variable\">$BIN_PATH</span>/redis-server <span class=\"token variable\">$CONF_FILE_PATH</span>\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m stop    <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 停止 Redis, <span class=\"token variable\">$BIN_PATH</span>/redis-cli shutdown\"</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m restart <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 重启 Redis, stop &amp;&amp; start\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[35m----------------------------------------------------------------------<span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m status  <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 当前运行状态、对应角色类型\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m running <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 当前运行状态，运行中返回 0，否则返回 1\"</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m role    <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 当前运行对应角色类型，master 返回 0， slave 返回 1, 其它 返回2， redis 未运行 返回9\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m slaveup <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 当前运行状态为slave时，master_link_status是否为up （是则返回0，否则为1）\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[35m----------------------------------------------------------------------<span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m tomaster   <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 运行状态转换角色类型为【master】\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m toslave    <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 运行状态转换角色类型为【slave】\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m startmaster<span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 未运行时，以【master】角色类型运行\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m startslave <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 未运行时，以【slave】角色类型运行\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\" -<span class=\"token entity\" title=\"\\e\">\\e</span>[32m startauto  <span class=\"token entity\" title=\"\\e\">\\e</span>[0m: 未运行时，根据slave.conf的master节点状态，自动判断当前节点以【master/slave】角色类型运行\"</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token comment\">#检查程序是否已运行</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token function-name function\">is_running</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token comment\"># 根据应用名称，获取进程 pid (当存在多个时不适用)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">#pid=`ps -ef|grep $APP_NAME|grep -v grep|awk '&#123;print $2&#125;'`</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token comment\"># 根据端口号获取对应 pid</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">#pid=$(lsof -t -i:$APP_PORT)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token assign-left variable\">pid</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">lsof</span> -i:$APP_PORT <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> *: <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">#如果不存在返回 1 存在返回 0</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;pid&#125;</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>   <span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>   <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token comment\"># 启动方法 </span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token function-name function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  is_running</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] is already running . pid=<span class=\"token variable\">$&#123;pid&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token variable\">$BIN_PATH</span>/redis-server <span class=\"token variable\">$CONF_FILE_PATH</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    status</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] start success . pid=<span class=\"token variable\">$&#123;pid&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] start fail .\"</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token comment\"># 用 master.conf 的配置文件替换 redis.conf 后启动</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token function-name function\">startmaster</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"准备以【 master 】模式启动，复制替换 redis.conf 文件...\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$MASTER_CONF_FILE_PATH</span> <span class=\"token variable\">$CONF_FILE_PATH</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  start  </pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token comment\"># 用 slave.conf 的配置文件替换 redis.conf 后启动</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token function-name function\">startslave</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"准备以【 slave 】模式启动，复制替换 redis.conf 文件...\"</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$SLAVE_CONF_FILE_PATH</span> <span class=\"token variable\">$CONF_FILE_PATH</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  start</pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token comment\"># 自动判断当前启用 master 还是 slave 模式</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token function-name function\">startauto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  is_running</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] is already running . pid=<span class=\"token variable\">$&#123;pid&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token comment\"># 读取 slave.conf 配置，获取对应 master 配置</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  <span class=\"token assign-left variable\">arr</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">cat</span> $SLAVE_CONF_FILE_PATH <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> ^replicaof<span class=\"token variable\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token assign-left variable\">master_host</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;arr<span class=\"token punctuation\">[</span>1<span class=\"token punctuation\">]</span>&#125;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  <span class=\"token assign-left variable\">master_port</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;arr<span class=\"token punctuation\">[</span>2<span class=\"token punctuation\">]</span>&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token assign-left variable\">authcmd</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> $SLAVE_CONF_FILE_PATH <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> ^masterauth <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/masterauth //g'</span> <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/\"//g'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token assign-left variable\">auth_key</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$authcmd</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token assign-left variable\">auth_key</span><span class=\"token operator\">=</span><span class=\"token string\">\"-a <span class=\"token variable\">$authcmd</span>\"</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"设置 master -h <span class=\"token variable\">$master_host</span> -p <span class=\"token variable\">$master_port</span> <span class=\"token variable\">$auth_key</span> \"</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token comment\"># 判断 master 配置中的服务，对应角色类型</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  <span class=\"token assign-left variable\">roleName</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>$BIN_PATH/redis-cli <span class=\"token parameter variable\">-h</span> $master_host <span class=\"token parameter variable\">-p</span> $master_port $auth_key info <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> role: <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/.$//g'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"slave 配置的 master 当前类型: <span class=\"token variable\">$roleName</span>\"</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$roleName</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"role:master\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    startslave</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    startmaster</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre><span class=\"token comment\"># 停止方法</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token function-name function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  is_running</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] is running . pid=<span class=\"token variable\">$&#123;pid&#125;</span> ; stoping...\"</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    <span class=\"token comment\"># 执行 shutdown</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    <span class=\"token variable\">$BIN_PATH</span>/redis-cli <span class=\"token variable\">$PASS_KEY</span> <span class=\"token function\">shutdown</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>    is_running</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] stop fail . pid=<span class=\"token variable\">$&#123;pid&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] stop success .\"</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>    <span class=\"token keyword\">fi</span>  </pre></td></tr><tr><td data-num=\"167\"></td><td><pre>  <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] is not running .\"</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre></pre></td></tr><tr><td data-num=\"172\"></td><td><pre><span class=\"token comment\">#重启</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre><span class=\"token function-name function\">restart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  stop</pre></td></tr><tr><td data-num=\"175\"></td><td><pre>  start</pre></td></tr><tr><td data-num=\"176\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre></pre></td></tr><tr><td data-num=\"178\"></td><td><pre><span class=\"token comment\"># 判断运行的角色 [master, slave]</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre><span class=\"token comment\"># master 返回 0， slave 返回 1, 其它 返回 2， redis 未运行 返回 9</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre><span class=\"token function-name function\">role</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>  is_running</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    <span class=\"token assign-left variable\">roleName</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>$BIN_PATH/redis-cli $PASS_KEY info <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> role: <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/.$//g'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$roleName</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"role:master\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$roleName</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"role:slave\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>      <span class=\"token comment\">#echo \"ERROR: unknow role: [$roleName] !!!\"</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>  <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    <span class=\"token comment\">#echo \"$APP_NAME - [PORT: $APP_PORT] is not running .\"</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre></pre></td></tr><tr><td data-num=\"198\"></td><td><pre><span class=\"token comment\"># 判断当前运行的 是否为 slave 且 正常连接上 master</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre><span class=\"token comment\"># 为简化逻辑，此处实现仅 在 info 信息中匹配 master_link_status:up （运行正常返回 0，否则为 1）</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre><span class=\"token comment\"># 即正常调用前，应该要知道此节点正常运行 且 为 slave</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre><span class=\"token function-name function\">slaveup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>  <span class=\"token assign-left variable\">linkStatus</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>$BIN_PATH/redis-cli $PASS_KEY info <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> master_link_status:up<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$linkStatus</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>   <span class=\"token comment\">#echo \"redis master link is down\"</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>   <span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>  <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"207\"></td><td><pre>   <span class=\"token comment\">#echo \"redis master link is up\"</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>   <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre></pre></td></tr><tr><td data-num=\"212\"></td><td><pre><span class=\"token comment\"># Change Redis to master; Use Command:  replicaof no one </span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre><span class=\"token function-name function\">tomaster</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>  role</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>  <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token variable\">$?</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$mode</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] 已经是[ master ] 不必要切换 .\"</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>  <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$mode</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"1\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>    <span class=\"token comment\"># 切换配置文件 - 避免下次重启后变化</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>    <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$MASTER_CONF_FILE_PATH</span> <span class=\"token variable\">$CONF_FILE_PATH</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>    <span class=\"token comment\"># 执行切换为 主服务</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>    <span class=\"token variable\">$BIN_PATH</span>/redis-cli <span class=\"token variable\">$PASS_KEY</span> replicaof no one</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>    <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>    status</pre></td></tr><tr><td data-num=\"225\"></td><td><pre>  <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"226\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] 不支持操作状态 [<span class=\"token variable\">$mode</span>].\"</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre></pre></td></tr><tr><td data-num=\"230\"></td><td><pre><span class=\"token comment\"># Change Redis to slave; Use Command:  replicaof masterip masterport</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre><span class=\"token function-name function\">toslave</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>  role</pre></td></tr><tr><td data-num=\"233\"></td><td><pre>  <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token variable\">$?</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$mode</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"1\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] 已经是[ slave ] 不必要切换 .\"</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>  <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$mode</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>    <span class=\"token comment\"># 切换配置文件 - 避免下次重启后变化</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>    <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$SLAVE_CONF_FILE_PATH</span> <span class=\"token variable\">$CONF_FILE_PATH</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"240\"></td><td><pre>    <span class=\"token assign-left variable\">authcmd</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> $CONF_FILE_PATH <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> ^masterauth <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/\"//g'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"设置 master 连接密码. <span class=\"token variable\">$authcmd</span>\"</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>    <span class=\"token comment\"># 执行更新密码</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>    <span class=\"token variable\">$BIN_PATH</span>/redis-cli <span class=\"token variable\">$PASS_KEY</span> config <span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$authcmd</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>    <span class=\"token assign-left variable\">repcmd</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> $CONF_FILE_PATH <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> ^replicaof<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"准备切换为[ slave ], <span class=\"token variable\">$repcmd</span>\"</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>    <span class=\"token comment\"># 执行切换为 从服务</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>    <span class=\"token variable\">$BIN_PATH</span>/redis-cli <span class=\"token variable\">$PASS_KEY</span> <span class=\"token variable\">$repcmd</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"250\"></td><td><pre>    <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>    status</pre></td></tr><tr><td data-num=\"252\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] 不支持操作状态 [<span class=\"token variable\">$mode</span>].\"</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre></pre></td></tr><tr><td data-num=\"257\"></td><td><pre><span class=\"token comment\"># 判断状态</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre><span class=\"token function-name function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>  is_running</pre></td></tr><tr><td data-num=\"260\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] is running . pid=<span class=\"token variable\">$&#123;pid&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>    role</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Redis is master role\"</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token string\">\"1\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Redis is slave role\"</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>    <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"268\"></td><td><pre>      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Redis is unknow role\"</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>  <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"271\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$APP_NAME</span> - [PORT: <span class=\"token variable\">$APP_PORT</span>] is not running .\"</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>  <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre></pre></td></tr><tr><td data-num=\"275\"></td><td><pre><span class=\"token comment\"># 根据输入的参数执行对应的方法</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token string\">\"<span class=\"token variable\">$1</span>\"</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>  <span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>    start</pre></td></tr><tr><td data-num=\"279\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>  <span class=\"token string\">\"stop\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>    stop</pre></td></tr><tr><td data-num=\"282\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>  <span class=\"token string\">\"running\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>    is_running</pre></td></tr><tr><td data-num=\"285\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>  <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>    status</pre></td></tr><tr><td data-num=\"288\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>  <span class=\"token string\">\"role\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>    role</pre></td></tr><tr><td data-num=\"291\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>  <span class=\"token string\">\"restart\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>    restart</pre></td></tr><tr><td data-num=\"294\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>  <span class=\"token string\">\"tomaster\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>    tomaster</pre></td></tr><tr><td data-num=\"297\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>  <span class=\"token string\">\"toslave\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>    toslave</pre></td></tr><tr><td data-num=\"300\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>  <span class=\"token string\">\"startmaster\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>    startmaster</pre></td></tr><tr><td data-num=\"303\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>  <span class=\"token string\">\"startslave\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>    startslave</pre></td></tr><tr><td data-num=\"306\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>  <span class=\"token string\">\"startauto\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>    startauto</pre></td></tr><tr><td data-num=\"309\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>  <span class=\"token string\">\"slaveup\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>    slaveup</pre></td></tr><tr><td data-num=\"312\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>  *<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>    usage</pre></td></tr><tr><td data-num=\"315\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr></table></figure><h2 id=\"5-配置开机启动服务\"><a class=\"markdownIt-Anchor\" href=\"#5-配置开机启动服务\">#</a> 5、配置开机启动服务</h2>\n<p>在系统服务目录  <code> /usr/lib/systemd/system/</code>  下，创建  <code>redis.service</code>  文件</p>\n<p>内容如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 服务描述</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Redis-Server</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 在 XX 服务后启动</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 服务运行参数； 注意本节点内命令要用绝对路径</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 后台运行方式</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>forking</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 启动命令</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/redis/redis.sh start</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 是否给服务分配独立的临时空间</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">PrivateTmp</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 运行级别下服务安装的相关设置， 可设置为多用户，即系统运行级别为 3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload           <span class=\"token comment\"># 重载 systemd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> redis.service    <span class=\"token comment\"># 设置开机启动</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>systemctl disable redis.service   <span class=\"token comment\"># 停止开机启动</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>systemctl start redis.service     <span class=\"token comment\"># 启动服务</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl stop redis.service      <span class=\"token comment\"># 停止服务</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>systemctl status redis.service    <span class=\"token comment\"># 查看服务状态</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>systemctl restart redis.service   <span class=\"token comment\"># 重启服务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>systemctl list-units <span class=\"token parameter variable\">--type</span><span class=\"token operator\">=</span>service   <span class=\"token comment\"># 查看所有已启动的服务</span></pre></td></tr></table></figure>",
            "tags": [
                "Redis"
            ]
        }
    ]
}